<link rel="import" href="../../iron-form-element-behavior/iron-form-element-behavior.html">
<link rel="import" href="../../iron-validatable-behavior/iron-validatable-behavior.html">
<link rel="import" href="../../paper-card/paper-card.html">
<link rel="import" href="../../mostly-elements/widgets/mostly-select2.html">

<!--
`playing-user-suggestion` allows selecting one or more users.

    <playing-user-suggestion search-type="group"
                           placeholder="Search for Groups"
                           value="{{groups}}"
                           multiple></playing-user-suggestion>

@group Playing Widgets
@element playing-user-suggestion
-->
<dom-module id="playing-user-suggestion">
  <template>

    <style>
      :host {
        display: block;
      }
    </style>

    <mostly-select2 id="s2"
            operation="find"
            path="user-groups"
            label="[[label]]"
            search-field="username"
            display-field="username"
            min-chars="[[minChars]]"
            multiple="[[multiple]]"
            params="[[params]]"
            placeholder="[[placeholder]]"
            readonly="[[readonly]]"
            value="{{value}}"
            selected-items="{{selectedItems}}"
            required="[[required]]"
            invalid="[[invalid]]"
            result-formatter="[[resultFormatter]]"
            resolve-entry="[[resolveEntry]]"
            id-function="[[idFunction]]">
    </mostly-select2>

  </template>

  <script>
    Polymer({
      is: 'playing-user-suggestion',
      behaviors: [Polymer.IronFormElementBehavior, Polymer.IronValidatableBehavior],
      properties: {

        // user or group or user-group
        searchType: {
          type: String,
          value: 'user-group'
        },

        /**
         * Label.
         */
        label: String,

        /**
         * Computed parameters for the `user-groups.suggestion` operation.
         */
        params: {
          type: Object,
          computed: '_computeParams(searchType)'
        },

        /**
         * Selected value(s).
         */
        value: {
          type: String,
          notify: true
        },

        /**
         * Set to `true` to allow multiple selection.
         */
        multiple: {
          type: Boolean,
          value: false
        },

        /**
         * Set to `true` for read only mode.
         */
        readonly: {
          type: Boolean,
          value: false
        },

        /**
         * Minimum number of chars to trigger the suggestions.
         */
        minChars: {
          type: Number,
          value: 2
        },

        /**
         * Placeholder.
         */
        placeholder: String,

        /**
         * Selected items.
         */
        selectedItems: {
          type: Object,
          notify: true
        },

        /**
         * Formatter for suggested entries.
         */
        resultFormatter: {
          type: Function,
          value: function() {
            return this._resultFormatter.bind(this);
          }
        },

        /**
         * Function that transforms entries added to the element using the `value` property into objects.
         */
        resolveEntry: {
          type: Function,
          value: function() {
            return this._resolveEntry.bind(this);
          }
        },

        /**
        * Set to true to submit ids prefixed with "user:" or "group:".
        */
        prefixed: Boolean,

        idFunction: {
          type: Function,
          value: function() {
            return this._idFunction.bind(this);
          }
        }
      },

      /* Override method from Polymer.IronValidatableBehavior. */
      _getValidity: function() {
        return this.$.s2._getValidity();
      },

      /* Override method from Polymer.IronValidatableBehavior. */
      validate: function(value) {
        this.invalid = !this.$.s2.validate();
        return !this.invalid;
      },

      _computeParams: function() {
        return this.params = {
          type: this.searchType,
          $limit: 100
        };
      },

      _resultFormatter: function(item) {
        return (item.label || item.title)
          + ((item.type && item.type === 'user') ? '<br>' + item.email : '');
      },

      _resolveEntry: function(term) {
        return this.prefixed
          ? {id: term, displayLabel: term, prefixed_id: term }
          : {id: term, displayLabel: term};
      },

      _idFunction: function(item) {
        return this.prefixed ? item.prefixed_id : item.id;
      }

    });
  </script>
</dom-module>
