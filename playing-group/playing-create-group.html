<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../paper-input/paper-input.html">
<link rel="import" href="../../paper-button/paper-button.html">
<link rel="import" href="../../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../iron-form/iron-form.html">
<link rel="import" href="../../mostly-elements/behaviors/mostly-i18n-behavior.html">
<link rel="import" href="../../mostly-elements/mostly-common/mostly-resource.html">
<link rel="import" href="../widgets/playing-user-suggestion.html">

<!--
Used by `playing-user-group-management`
@group Playing Elements
@element playing-create-group
-->
<dom-module id="playing-create-group">
  <template>
    <style include="mostly-styles iron-flex-alignment">
      :host {
        display: block;
      }

      .backButton {
        var(--mostly-button-primary, #00adff);
      }

      .header > iron-icon {
        padding: 8px;
      }

      form {
        margin: 24px 0 0;
      }

      paper-button.primary {
        background-color: var(--mostly-button-primary, #00adff);
        color: #fff;
      }

      paper-button.primary:hover,
      paper-button.primary:focus {
        background-color: var(--mostly-button-primary-focus, #0079b3);
        font-weight: inherit;
        color: #fff !important;
      }

      .search-entry {
        border: 1px solid #aaa;
        padding: 4px;
        font-size: .8rem;
        @apply --layout-horizontal;
        @apply --layout-center;
      }

      .search-entry + .search-entry {
        margin-top: 8px;
      }

      .search-entry .user-info {
        padding: 0.2em 0.6em;
        text-align: center;
        width: 30%;
        @apply --layout-horizontal;
        @apply --layout-center;
        @apply --layout-center-justified;
      }

      .search-entry .user-info .label {
        text-align: center;
        font-weight: bold;
        @apply --layout-horizontal;
        @apply --layout-center;
      }

      .search-entry iron-icon {
        --iron-icon-height: 14px;
        --iron-icon-width: 14px;
        margin-right: 4px;
      }

      .search-entry paper-icon-button {
        width: 32px;
        height: 32px;
      }

      #another {
        margin: 2em 0;
      }

      #errors {
        color: red;
        margin: 1em 0;
      }

      .header h3 {
        margin-bottom: 0;
      }

      h3 iron-icon {
        width: 1.3em;
        margin-right: .2rem;
      }

      .form-buttons {
        padding: 1em;
        margin: 16px -1.2rem 0;
      }
    </style>

    <mostly-resource id="request" path="groups"></mostly-resource>

    <div class="header horizontal layout center">
      <paper-icon-button class="backButton" icon="icons:arrow-back" on-tap="_goHome"></paper-icon-button>
      <h3><iron-icon icon="mostly:group"></iron-icon>[[i18n('createGroup.heading')]]</h3>
    </div>

    <iron-form id="form">
      <form class="vertical layout">

        <paper-input id="groupName"
                label="[[i18n('createGroup.group.name')]]"
                value="{{groupName}}" required always-float-label></paper-input>
        <paper-input id="groupLabel"
                label="[[i18n('createGroup.group.label')]]"
                value="{{groupLabel}}" always-float-label></paper-input>

        <playing-user-suggestion id="picker"
                label="[[i18n('createGroup.members')]]"
                search-type="user-group"
                placeholder="[[i18n('createGroup.search.placeholder')]]"
                value="[[selectedUser]]"
                selected-items="{{selectedUser}}"
                result-formatter="[[resultFormatter]]"
                query-results-filter="[[resultsFilter]]">
        </playing-user-suggestion>

        <!-- selected members -->
        <div class="vertical layout flex">
          <template is="dom-repeat" items="[[selectedUsers]]">
            <div class="search-entry">
              <div class="user-info">
                <div class="label">
                  <iron-icon icon="mostly:user" hidden="[[item.groupname]]"></iron-icon>
                  <iron-icon icon="mostly:group" hidden="[[item.username]]"></iron-icon>
                  <span>[[item.displayLabel]]</span>
                </div>
              </div>
              <div class="user-info">
                <span class="username" hidden="[[item.groupname]]">[[item.username]]</span>
                <span class="username" hidden="[[item.username]]">[[item.groupname]]</span>
              </div>
              <div class="user-info">
                <span class="email">[[item.email]]</span>
              </div>
              <paper-icon-button icon="mostly:remove" title="remove" on-tap="_remove"></paper-icon-button>
            </div>
          </template>
        </div>

        <paper-checkbox noink id="another">[[i18n('createGroup.createAnother.checkbox')]]</paper-checkbox>

        <div class="form-buttons">
          <paper-button noink id="cancelButton" on-tap="_cancel">[[i18n('command.cancel')]]</paper-button>
          <paper-button noink id="createButton" class="primary" on-tap="_submit">[[i18n('command.create')]]</paper-button>
          <paper-button noink id="createAnotherButton" class="primary" on-tap="_submitAnother">
            [[i18n('createGroup.createAnother')]]
          </paper-button>
        </div>

        <span id="errors" hidden$="[[!_hasErrors(errors)]]">[[errors]]</span>

      </form>
    </iron-form>
  </template>

  <script>
    Polymer({
      is: 'playing-create-group',
      behaviors: [Mostly.I18nBehavior],
      properties: {
        groupName: {
          type: String,
          notify: true
        },

        groupLabel: {
          type: String,
          notify: true
        },

        selectedUser: {
          type: Object,
          notify: true
        },

        selectedUsers: {
          type: Array,
          value: [],
          notify: true
        },

        resultsFilter: {
          type: Function,
          value: function() {
            return this._resultsFilter.bind(this);
          }
        },

        resultFormatter: {
          type: Function,
          value: function() {
            return this._resultFormatter.bind(this);
          }
        },

        errors: {
          type: String,
          value: ''
        },

        /**
         * If true, allows to create a new group immediately after the current one is created
         */
        _createAnother: {
          type: Boolean,
          value: false
        }
      },

      observers: [
        '_observeSelectedUser(selectedUser)'
      ],

      ready: function() {
        this.$.form.addEventListener('iron-form-presubmit', (event) => {
          event.preventDefault();
          this._create();
        });
      },

      _goHome: function() {
        this.fire('goHome');
      },

      _observeSelectedUser: function() {
        if (this.selectedUser && this.selectedUsers.indexOf(this.selectedUser) === -1) {
          this.push('selectedUsers', this.selectedUser);
        }
        this.selectedUser = null;
      },

      _remove: function(e) {
        if (e.model.item) {
          this.splice('selectedUsers', this.selectedUsers.indexOf(e.model.item), 1);
        }
      },

      /**
       * Submits the form with `_createAnother` option set to true.
       */
      _submitAnother: function() {
        this._createAnother = true;
        this.$.form.submit();
      },

      /**
       * Submits the form.
       */
      _submit: function() {
        this._createAnother = false;
        this.$.form.submit();
      },

      /**
       * Creates a new group if the form was successfully submitted.
       */
      _create: function() {
        this.$.request.data = this._computeData();
        this.$.request.post().then((response) => {
          this.fire('playing-group-created', response.data);
          this._resetFields();
          if (!this.$.another.checked) {
            this._goHome();
          }
        }).catch((error) => {
          this.errors = error.message;
        });
      },

      _cancel: function() {
        this._resetFields();
        this._goHome();
      },

      _resetFields: function() {
        this.groupName = '';
        this.groupLabel = '';
        this.errors = '';
        this.selectedUsers = [];
      },

      _computeData: function() {
        return {
          "type": "group",
          "groupname": this.groupName,
          "label": this.groupLabel,
          "users": this.selectedUsers.filter((record) => {
            return record.type === 'user';
          }).map((record) => {
            return record.id;
          }),
          "groups": this.selectedUsers.filter((record) => {
            return record.type === 'group';
          }).map((record) => {
            return record.id;
          })
        };
      },

      _resultsFilter: function(entry) {
        for (var i = 0; i < this.selectedUsers.length; i++) {
          if (entry.id === this.selectedUsers[i].id) {
            return false;
          }
        }
        return true;
      },

      _resultFormatter: function(item) {
        return item.displayLabel + ' (' + (item.groupname || item.username) + ')';
      },

      _hasErrors: function() {
        return this.errors !== '';
      }
    });
  </script>
</dom-module>